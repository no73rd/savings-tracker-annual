<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØªØ­ÙˆÙŠØ´ Ø§Ù„Ø±Ø³Ù…ÙŠ - Firebase</title>
<style>
  body { font-family: 'Cairo', sans-serif; background:#eef; padding: 20px; }
  .container { max-width: 520px; margin: auto; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 0 15px rgba(0,0,0,0.1);}
  input, select, button { width: 100%; margin: 10px 0; padding: 8px; font-size: 16px; border-radius: 6px; border: 1px solid #ccc; }
  button { cursor: pointer; background: #00695c; color: white; border: none; }
  button:hover { background: #004d40; }
  .hidden { display: none !important; }
  .link { color: #00695c; cursor: pointer; text-align: center; margin-top: 10px; user-select:none; }
  table { width: 100%; border-collapse: collapse; margin-top: 15px; }
  th, td { border: 1px solid #ccc; padding: 10px; text-align: center; }
  th { background-color: #00695c; color: white; }
  .checkmark {
    color: green;
    font-weight: bold;
    font-size: 1.3em;
    user-select:none;
    cursor:pointer;
    transition: all 0.3s ease;
  }
  .no-mark {
    color: #bbb;
    font-size: 1.3em;
    user-select:none;
    cursor:pointer;
    transition: all 0.3s ease;
  }
  .checkmark.animate {
    animation: glow 0.7s ease forwards;
  }
  @keyframes glow {
    0% { text-shadow: 0 0 5px #4caf50; transform: scale(1); }
    50% { text-shadow: 0 0 15px #4caf50; transform: scale(1.3); }
    100% { text-shadow: 0 0 5px #4caf50; transform: scale(1); }
  }
  #logoutBtn { background-color: #c62828; margin-bottom: 20px; }
  #logoutBtn:hover { background-color: #8e0000; }
  #monthlyGoal, #monthlySaved, #monthlyRemaining {
    font-weight: bold;
    font-size: 1.1em;
    margin-top: -6px;
    margin-bottom: 8px;
    color: #004d40;
    user-select: none;
  }
</style>
</head>
<body>

<div class="container" id="authSection">
  <h2 id="authTitle">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
  <form id="authForm">
    <input type="email" id="emailInput" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" required autocomplete="username" />
    <input type="password" id="passwordInput" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" required autocomplete="current-password" />
    <button type="submit" id="authButton">Ø¯Ø®ÙˆÙ„</button>
  </form>
  <div class="link" id="toggleAuth">Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø³Ø¬Ù„ Ù‡Ù†Ø§</div>
</div>

<div class="container hidden" id="dashboardSection">
  <button id="logoutBtn">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
  <h2>Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØªØ­ÙˆÙŠØ´ Ø§Ù„Ø±Ø³Ù…ÙŠ</h2>

  <label for="yearSelect">Ø§Ø®ØªØ± Ø§Ù„Ø³Ù†Ø©:</label>
  <select id="yearSelect"></select>

  <label for="monthSelect">Ø§Ø®ØªØ± Ø§Ù„Ø´Ù‡Ø±:</label>
  <select id="monthSelect"></select>

  <label for="dailyAmountInput">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙŠÙˆÙ…ÙŠ (Ø¬Ù†ÙŠÙ‡):</label>
  <input type="number" id="dailyAmountInput" min="1" step="1" placeholder="Ø­Ø¯Ø¯ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙŠÙˆÙ…ÙŠ" />
  
  <div id="monthlyGoal">ğŸ¯ Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ø´Ù‡Ø±ÙŠ: 0 Ø¬Ù†ÙŠÙ‡</div>
  <div id="monthlySaved">ğŸ’° Ø§Ù„Ù…Ø­ÙˆØ´ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†: 0 Ø¬Ù†ÙŠÙ‡</div>
  <div id="monthlyRemaining">â³ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: 0 Ø¬Ù†ÙŠÙ‡</div>

  <button id="saveDailyAmountBtn">Ø­ÙØ¸ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø´Ù‡Ø±ÙŠ</button>

  <table>
    <thead>
      <tr>
        <th>Ø§Ù„ÙŠÙˆÙ…</th>
        <th>ØªÙ… Ø§Ù„ØªØ­ÙˆÙŠØ´ØŸ</th>
      </tr>
    </thead>
    <tbody id="daysTableBody"></tbody>
  </table>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
  // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyBwyZ-s1kbwQ5eXEP2Sn5vSWQvMuwvatMA",
    authDomain: "saver-abb7a.firebaseapp.com",
    projectId: "saver-abb7a",
    storageBucket: "saver-abb7a.appspot.com",
    messagingSenderId: "1053395200635",
    appId: "1:1053395200635:web:116749d7c4f0be4d3710de",
    measurementId: "G-2V0GHBT5HB"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  const authSection = document.getElementById('authSection');
  const dashboardSection = document.getElementById('dashboardSection');
  const authForm = document.getElementById('authForm');
  const emailInput = document.getElementById('emailInput');
  const passwordInput = document.getElementById('passwordInput');
  const authButton = document.getElementById('authButton');
  const toggleAuth = document.getElementById('toggleAuth');
  const authTitle = document.getElementById('authTitle');
  const logoutBtn = document.getElementById('logoutBtn');
  const yearSelect = document.getElementById('yearSelect');
  const monthSelect = document.getElementById('monthSelect');
  const dailyAmountInput = document.getElementById('dailyAmountInput');
  const saveDailyAmountBtn = document.getElementById('saveDailyAmountBtn');
  const daysTableBody = document.getElementById('daysTableBody');
  const monthlyGoalDiv = document.getElementById('monthlyGoal');
  const monthlySavedDiv = document.getElementById('monthlySaved');
  const monthlyRemainingDiv = document.getElementById('monthlyRemaining');

  const months = [
    'ÙŠÙ†Ø§ÙŠØ±', 'ÙØ¨Ø±Ø§ÙŠØ±', 'Ù…Ø§Ø±Ø³', 'Ø£Ø¨Ø±ÙŠÙ„', 'Ù…Ø§ÙŠÙˆ', 'ÙŠÙˆÙ†ÙŠÙˆ',
    'ÙŠÙˆÙ„ÙŠÙˆ', 'Ø£ØºØ³Ø·Ø³', 'Ø³Ø¨ØªÙ…Ø¨Ø±', 'Ø£ÙƒØªÙˆØ¨Ø±', 'Ù†ÙˆÙÙ…Ø¨Ø±', 'Ø¯ÙŠØ³Ù…Ø¨Ø±'
  ];
  const daysInMonth = {
    'ÙŠÙ†Ø§ÙŠØ±': 31, 'ÙØ¨Ø±Ø§ÙŠØ±': 28, 'Ù…Ø§Ø±Ø³': 31, 'Ø£Ø¨Ø±ÙŠÙ„': 30,
    'Ù…Ø§ÙŠÙˆ': 31, 'ÙŠÙˆÙ†ÙŠÙˆ': 30, 'ÙŠÙˆÙ„ÙŠÙˆ': 31, 'Ø£ØºØ³Ø·Ø³': 31,
    'Ø³Ø¨ØªÙ…Ø¨Ø±': 30, 'Ø£ÙƒØªÙˆØ¨Ø±': 31, 'Ù†ÙˆÙÙ…Ø¨Ø±': 30, 'Ø¯ÙŠØ³Ù…Ø¨Ø±': 31
  };

  let isLogin = true;
  let currentUser = null;
  let currentUserData = {};

  toggleAuth.onclick = () => {
    isLogin = !isLogin;
    authTitle.textContent = isLogin ? 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„' : 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯';
    authButton.textContent = isLogin ? 'Ø¯Ø®ÙˆÙ„' : 'ØªØ³Ø¬ÙŠÙ„';
    toggleAuth.textContent = isLogin ? 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø³Ø¬Ù„ Ù‡Ù†Ø§' : 'Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
    passwordInput.autocomplete = isLogin ? 'current-password' : 'new-password';
  };

  function fillYearSelect() {
    yearSelect.innerHTML = '';
    for(let y = 2023; y <= 2030; y++) {
      yearSelect.innerHTML += `<option value="${y}">${y}</option>`;
    }
  }

  function fillMonthSelect() {
    monthSelect.innerHTML = '';
    months.forEach(m => {
      monthSelect.innerHTML += `<option value="${m}">${m}</option>`;
    });
  }

  function isLeapYear(year) {
    return (year % 4 === 0 && year % 100 !== 0) || (year % 400 === 0);
  }

  async function loadSavingsData(uid) {
    const doc = await db.collection('savings').doc(uid).get();
    return doc.exists ? doc.data() : {};
  }

  async function saveSavingsData(uid, data) {
    await db.collection('savings').doc(uid).set(data);
  }

  async function updateDaysTable() {
    daysTableBody.innerHTML = '';
    if (!currentUser) return;
    const year = yearSelect.value;
    const month = monthSelect.value;
    if (!year || !month) return;

    let daysCount = daysInMonth[month];
    if (month === 'ÙØ¨Ø±Ø§ÙŠØ±' && isLeapYear(parseInt(year))) daysCount = 29;

    if (!currentUserData[year]) currentUserData[year] = {};
    if (!currentUserData[year][month]) {
      currentUserData[year][month] = { dailyAmount: 0, daysSaved: {} };
    }

    dailyAmountInput.value = currentUserData[year][month].dailyAmount || '';
    const dailyAmount = currentUserData[year][month].dailyAmount || 0;
    const monthlyGoal = dailyAmount * daysCount;
    monthlyGoalDiv.textContent = `ğŸ¯ Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ø´Ù‡Ø±ÙŠ: ${monthlyGoal} Ø¬Ù†ÙŠÙ‡`;

    const savedDays = Object.keys(currentUserData[year][month].daysSaved || {}).length;
    const savedAmount = savedDays * dailyAmount;
    const remaining = monthlyGoal - savedAmount;

    monthlySavedDiv.textContent = `ğŸ’° Ø§Ù„Ù…Ø­ÙˆØ´ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†: ${savedAmount} Ø¬Ù†ÙŠÙ‡`;
    monthlyRemainingDiv.textContent = `â³ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${remaining} Ø¬Ù†ÙŠÙ‡`;

    for(let day = 1; day <= daysCount; day++) {
      const tr = document.createElement('tr');
      const tdDay = document.createElement('td');
      tdDay.textContent = day;
      const tdCheck = document.createElement('td');
      const isSaved = currentUserData[year][month].daysSaved[day];
      tdCheck.innerHTML = isSaved ? '<span class="checkmark">âœ“</span>' : '<span class="no-mark">â€“</span>';

      tdCheck.onclick = async () => {
        if (dailyAmount <= 0) return alert('Ø­Ø¯Ø¯ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙŠÙˆÙ…ÙŠ Ø£ÙˆÙ„Ø§Ù‹');
        if (isSaved) {
          delete currentUserData[year][month].daysSaved[day];
        } else {
          currentUserData[year][month].daysSaved[day] = true;
        }
        await saveSavingsData(currentUser.uid, currentUserData);
        await updateDaysTable();
        const checkSpan = tdCheck.querySelector('span');
        checkSpan.classList.add('animate');
        setTimeout(() => checkSpan.classList.remove('animate'), 700);
      };

      tr.appendChild(tdDay);
      tr.appendChild(tdCheck);
      daysTableBody.appendChild(tr);
    }
  }

  saveDailyAmountBtn.onclick = async () => {
    const year = yearSelect.value;
    const month = monthSelect.value;
    const amount = parseFloat(dailyAmountInput.value);
    if (!year || !month) return alert('Ø§Ø®ØªØ± Ø§Ù„Ø³Ù†Ø© ÙˆØ§Ù„Ø´Ù‡Ø± Ø£ÙˆÙ„Ø§Ù‹');
    if (!amount || amount <= 0) return alert('Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº ÙŠÙˆÙ…ÙŠ ØµØ§Ù„Ø­');

    if (!currentUserData[year]) currentUserData[year] = {};
    if (!currentUserData[year][month]) currentUserData[year][month] = { dailyAmount: 0, daysSaved: {} };

    currentUserData[year][month].dailyAmount = amount;
    await saveSavingsData(currentUser.uid, currentUserData);
    alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙŠÙˆÙ…ÙŠ');
    await updateDaysTable();
  };

  auth.onAuthStateChanged(async (user) => {
    if (user) {
      currentUser = user;
      authSection.classList.add('hidden');
      dashboardSection.classList.remove('hidden');
      fillYearSelect();
      fillMonthSelect();
      currentUserData = await loadSavingsData(user.uid);
      yearSelect.value = new Date().getFullYear();
      monthSelect.value = months[new Date().getMonth()];
      updateDaysTable();
    } else {
      currentUser = null;
      authSection.classList.remove('hidden');
      dashboardSection.classList.add('hidden');
    }
  });

  authForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = emailInput.value.trim();
    const password = passwordInput.value;
    try {
      if (isLogin) {
        await auth.signInWithEmailAndPassword(email, password);
      } else {
        await auth.createUserWithEmailAndPassword(email, password);
        alert('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­');
      }
      authForm.reset();
    } catch (error) {
      alert(error.message);
    }
  });

  logoutBtn.onclick = () => auth.signOut();
</script>
</body>
</html>
